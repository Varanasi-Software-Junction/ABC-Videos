<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Centered Expansion — Video in last section</title>
  <style>
    :root{
      --bg:#fafafa;
      --box-bg:#e8e8e8;
      --highlight:#2a9d8f;
      --anim-duration:520ms;
      --close-size:44px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:var(--bg);
      color:#111;
    }

    .spacer { height:100vh; display:flex; align-items:center; justify-content:center; color:#666; }

    .content {
      min-height: 60vh;
      margin: 48px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--box-bg);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.06);
      padding: 28px;
      text-align:center;
      font-size: 1.1rem;
      transition: none;
      will-change: transform, left, top, width, height;
      position: relative;
      overflow: hidden;
    }

    .inner { max-width: 900px; width:100%; display:flex; flex-direction:column; gap:18px; align-items:center; }

    .placeholder-svg,
    .placeholder-video {
      width: 100%;
      max-height: 48vh; /* keep media visible but not overflow */
      height: auto;
      display: block;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      background: #f6f6f6;
    }

    /* For video we want it to cover the box nicely while preserving aspect ratio */
    .placeholder-video {
      object-fit: cover;
    }

    .caption { font-size: 1rem; color: #222; }

    .content.visible { box-shadow: 0 12px 36px rgba(0,0,0,0.10); }

    .expanding { border-radius: 10px; }

    .exp-close {
      position: fixed;
      right: 18px;
      top: 18px;
      width: var(--close-size);
      height: var(--close-size);
      border-radius: 8px;
      border: 0;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      cursor:pointer;
      z-index: 12001;
    }

    @media (prefers-reduced-motion: reduce) {
      :root { --anim-duration: 0ms; }
      .content { transition: none !important; }
    }

    @media (max-width:700px){
      .placeholder-svg, .placeholder-video { max-height: 40vh; }
      .content { min-height: 50vh; padding: 20px; margin: 28px 10px; }
    }

    footer.note { text-align:center; color:#666; padding:18px; font-size:.95rem;}
  </style>
</head>
<body>
  <div class="spacer">Scroll down — sections expand to fullscreen and will be centered. The last section contains a video (videos/0.mp4).</div>

  <section class="content" id="c1">
    <div class="inner">
      <!-- SVG placeholder A -->
      <svg class="placeholder-svg" role="img" aria-label="Placeholder image for Section A — abstract mountains" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="gA" x1="0" x2="1">
            <stop offset="0%" stop-color="#e0f7f1"/>
            <stop offset="100%" stop-color="#a8e6dc"/>
          </linearGradient>
        </defs>
        <rect width="1200" height="700" fill="url(#gA)"/>
        <g transform="translate(80,380)" fill="#7fc5b6">
          <path d="M0 220 L160 40 L310 220 Z"/>
          <path d="M220 220 L390 80 L560 220 Z" fill="#6fb5a6"/>
          <path d="M480 220 L720 20 L950 220 Z" fill="#5ea596"/>
        </g>
        <circle cx="980" cy="120" r="48" fill="#ffd27a" opacity="0.95"/>
        <text x="50" y="90" font-family="system-ui, Arial" font-size="44" fill="#0b5a4a">Section A</text>
      </svg>
      <div class="caption"><strong>Section A</strong> — SVG placeholder (mountains style).</div>
    </div>
  </section>

  <section class="content" id="c2">
    <div class="inner">
      <!-- SVG placeholder B -->
      <svg class="placeholder-svg" role="img" aria-label="Placeholder image for Section B — geometric shapes" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="gB" x1="0" x2="1">
            <stop offset="0%" stop-color="#fff3e0"/>
            <stop offset="100%" stop-color="#ffd9b3"/>
          </linearGradient>
        </defs>
        <rect width="1200" height="700" fill="url(#gB)"/>
        <g fill-opacity="0.95">
          <rect x="120" y="120" width="340" height="260" rx="18" fill="#f4a261"/>
          <circle cx="760" cy="230" r="120" fill="#e76f51"/>
          <rect x="520" y="380" width="480" height="220" rx="24" fill="#2a9d8f"/>
        </g>
        <text x="60" y="92" font-family="system-ui, Arial" font-size="44" fill="#5a3a28">Section B</text>
      </svg>
      <div class="caption"><strong>Section B</strong> — SVG placeholder (geometric blocks).</div>
    </div>
  </section>

  <section class="content" id="c3">
    <div class="inner">
      <!-- SVG placeholder C -->
      <svg class="placeholder-svg" role="img" aria-label="Placeholder image for Section C — device mockup" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="gC" x1="0" x2="1">
            <stop offset="0%" stop-color="#f0f6ff"/>
            <stop offset="100%" stop-color="#d6e8ff"/>
          </linearGradient>
        </defs>
        <rect width="1200" height="700" fill="url(#gC)"/>
        <!-- device -->
        <rect x="200" y="110" rx="28" ry="28" width="420" height="620" fill="#ffffff" stroke="#cfe3ff" stroke-width="6"/>
        <rect x="600" y="150" rx="24" ry="24" width="360" height="540" fill="#0b78ff" opacity="0.09"/>
        <!-- little content -->
        <g transform="translate(240,160)" fill="#7a92d6">
          <rect width="360" height="36" rx="8"/>
          <rect y="70" width="320" height="18" rx="6"/>
          <rect y="110" width="320" height="18" rx="6"/>
          <rect y="150" width="320" height="18" rx="6"/>
        </g>
        <text x="60" y="94" font-family="system-ui, Arial" font-size="44" fill="#274060">Section C</text>
      </svg>
      <div class="caption"><strong>Section C</strong> — SVG placeholder (device / mockup).</div>
    </div>
  </section>

  <section class="content" id="c4">
    <div class="inner">
      <!-- Video placeholder D -->
      <video
        class="placeholder-video"
        src="videos/0.mp4"
        role="img"
        aria-label="Video placeholder for Section D"
        playsinline
        muted
        autoplay
        loop
        controls
      ></video>
      <div class="caption"><strong>Section D</strong> — Video (videos/0.mp4).</div>
    </div>
  </section>

  <div class="spacer"></div>

  <footer class="note">Centered expansion: the last section contains a responsive video element that scales during expand/shrink.</footer>

  <script>
    (function(){
      const sections = Array.from(document.querySelectorAll('.content'));
      const animDuration = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--anim-duration')) || 520;
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      let currentlyExpanded = null;
      let placeholder = null;
      let closeBtn = null;
      let isAnimating = false;

      function fixElementAtRect(el, rect) {
        el.style.position = 'fixed';
        el.style.left = rect.left + 'px';
        el.style.top = rect.top + 'px';
        el.style.width = rect.width + 'px';
        el.style.height = rect.height + 'px';
        el.style.margin = '0';
        el.style.zIndex = 12000;
        el.classList.add('expanding');
        el.style.transformOrigin = '50% 50%';
      }

      function restoreElement(el) {
        el.style.position = '';
        el.style.left = '';
        el.style.top = '';
        el.style.width = '';
        el.style.height = '';
        el.style.margin = '';
        el.style.zIndex = '';
        el.style.transform = '';
        el.style.transition = '';
        el.style.transformOrigin = '';
        el.classList.remove('expanding');
      }

      function ensureCloseButton() {
        if (closeBtn) return;
        closeBtn = document.createElement('button');
        closeBtn.className = 'exp-close';
        closeBtn.innerHTML = '✕';
        closeBtn.title = 'Close';
        document.body.appendChild(closeBtn);
        closeBtn.addEventListener('click', () => {
          if (!isAnimating) shrinkCurrent();
        });
      }

      function removeCloseButton() {
        if (!closeBtn) return;
        closeBtn.removeEventListener('click', shrinkCurrent);
        if (closeBtn.parentNode) closeBtn.parentNode.removeChild(closeBtn);
        closeBtn = null;
      }

      function expandContent(section) {
        return new Promise((resolve) => {
          if (isAnimating) { resolve(); return; }
          isAnimating = true;
          ensureCloseButton();

          const rect = section.getBoundingClientRect();
          const vw = window.innerWidth;
          const vh = window.innerHeight;

          // placeholder to preserve layout
          placeholder = document.createElement('div');
          placeholder.style.width = rect.width + 'px';
          placeholder.style.height = rect.height + 'px';
          placeholder.style.margin = getComputedStyle(section).margin;
          section.parentNode.insertBefore(placeholder, section);

          fixElementAtRect(section, rect);

          // compute scale factors
          const scaleX = vw / rect.width;
          const scaleY = vh / rect.height;

          // compute translation to center element's center in viewport
          const elemCenterX = rect.left + rect.width / 2;
          const elemCenterY = rect.top + rect.height / 2;
          const translateX = (vw / 2) - elemCenterX;
          const translateY = (vh / 2) - elemCenterY;

          section.style.transition = `transform ${animDuration}ms cubic-bezier(.22,.9,.35,1)`;
          section.getBoundingClientRect();

          if (prefersReduced) {
            section.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
            isAnimating = false;
            currentlyExpanded = section;
            resolve();
            return;
          }

          function onEnd() {
            section.removeEventListener('transitionend', onEnd);
            isAnimating = false;
            currentlyExpanded = section;
            resolve();
          }

          let called = false;
          const fallback = setTimeout(() => {
            if (!called) { called = true; onEnd(); }
          }, animDuration + 80);

          section.addEventListener('transitionend', () => {
            if (called) return;
            called = true;
            clearTimeout(fallback);
            onEnd();
          }, { once: true });

          requestAnimationFrame(() => {
            section.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
            if (closeBtn) closeBtn.focus();
          });
        });
      }

      function shrinkCurrent() {
        return new Promise((resolve) => {
          if (!currentlyExpanded) { resolve(); return; }
          if (isAnimating) { resolve(); return; }
          isAnimating = true;
          const section = currentlyExpanded;

          section.style.transition = `transform ${animDuration}ms cubic-bezier(.22,.9,.35,1)`;

          if (prefersReduced) {
            restoreElement(section);
            if (placeholder && placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
            placeholder = null;
            removeCloseButton();
            currentlyExpanded = null;
            isAnimating = false;
            resolve();
            return;
          }

          function onEnd() {
            section.removeEventListener('transitionend', onEnd);
            restoreElement(section);
            if (placeholder && placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
            placeholder = null;
            removeCloseButton();
            currentlyExpanded = null;
            isAnimating = false;
            resolve();
          }

          let called = false;
          const fallback = setTimeout(() => {
            if (!called) { called = true; onEnd(); }
          }, animDuration + 80);

          section.addEventListener('transitionend', () => {
            if (called) return;
            called = true;
            clearTimeout(fallback);
            onEnd();
          }, { once: true });

          requestAnimationFrame(() => {
            section.style.transform = `none`;
          });
        });
      }

      const obsOptions = { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.5 };
      const observer = new IntersectionObserver(async (entries) => {
        let best = null;
        entries.forEach(e => {
          if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
          if (e.isIntersecting && e.intersectionRatio >= obsOptions.threshold) e.target.classList.add('visible');
          else e.target.classList.remove('visible');
        });

        if (!best) return;
        if (best.isIntersecting && best.intersectionRatio >= obsOptions.threshold) {
          const target = best.target;
          if (currentlyExpanded === target) return;

          if (currentlyExpanded && currentlyExpanded !== target) {
            await shrinkCurrent();
            await new Promise(res => requestAnimationFrame(res));
          }

          if (!currentlyExpanded) {
            await expandContent(target);
          }
        }
      }, obsOptions);

      sections.forEach(s => observer.observe(s));

      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && currentlyExpanded && !isAnimating) shrinkCurrent();
      });

      document.addEventListener('click', (ev) => {
        if (!currentlyExpanded || isAnimating) return;
        if (currentlyExpanded.contains(ev.target)) return;
        if (closeBtn && closeBtn.contains(ev.target)) return;
        shrinkCurrent();
      }, true);

      window.addEventListener('resize', () => {
        if (!currentlyExpanded) return;
        const section = currentlyExpanded;
        if (!placeholder) return;
        const rect = placeholder.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const scaleX = vw / rect.width;
        const scaleY = vh / rect.height;
        const elemCenterX = rect.left + rect.width / 2;
        const elemCenterY = rect.top + rect.height / 2;
        const translateX = (vw / 2) - elemCenterX;
        const translateY = (vh / 2) - elemCenterY;
        section.style.transition = 'transform 0ms';
        section.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
      });

    })();
  </script>
</body>
</html>
